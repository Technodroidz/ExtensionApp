name: Continuous Delivery for iOS using Fastlane and GitHub Actions

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Xcode
        uses: xcpretty/xcode-install@v2
        with:
          xcode-version: "13.2.1"

      - name: Install Bundler
        run: |
          gem install bundler
          bundle install
        working-directory: ./SafariExtApp

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          pod install
        working-directory: ./SafariExtApp

      - name: Build and sign archive
        run: |
          bundle exec fastlane build
          bundle exec fastlane sign
        working-directory: ./SafariExtApp

      - name: Upload to TestFlight
        uses: apple/upload-app@v1
        with:
          app-path: ./SafariExtApp/build/ExtApp.ipa
          bundle-id: com.example.ExtApp
          provider-shortname: ${{ secrets.APP_STORE_CONNECT_PROVIDER_SHORTNAME }}
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          private-key: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
