name: Generate and Deploy IPA to TestFlight

on:
  push:
    branches:
      - main

env:
  SCHEME_NAME: extApp
  PROJECT_NAME: SafariExtApp
  WORKSPACE_NAME: extApp
  CERTIFICATE_NAME: "Gaurav Tomar"
  PROVISIONING_PROFILE: "aff4a280-1664-401b-a9ee-4bbd5b35b021"
  DEVELOPER_TEAM_ID: "994WFWD5VD"
  SDK: "iphoneos"

jobs:
  deploy:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Xcode
        run: sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install dependencies
        run: pod install
        working-directory: ./SafariExtApp

      # - name: Archive and Export
      #   run: |
      #     xcodebuild -workspace $WORKSPACE_NAME.xcworkspace -scheme $SCHEME_NAME -sdk $SDK -configuration Release clean archive -archivePath build/$PROJECT_NAME.xcarchive PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE" CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY="$CERTIFICATE_NAME" DEVELOPMENT_TEAM="$DEVELOPER_TEAM_ID"
      #     xcodebuild -exportArchive -archivePath build/$PROJECT_NAME.xcarchive -exportPath build -exportOptionsPlist ExportOptions.plist
      #   working-directory: ./SafariExtApp

      # - name: Install transporter
      #   run: |
      #     sudo gem install jwt
      #     sudo gem install fastlane
      #     brew install libxml2
      #     sudo gem install nokogiri -- --use-system-libraries=true --with-xml2-include=/usr/local/opt/libxml2/include/libxml2 --with-xml2-lib=/usr/local/opt/libxml2/lib
      #     sudo gem install spaceship
      #     sudo gem install transporter 

      # - name: Import Distribution Certificate and Key
      #   run: |
      #     echo "${{ secrets.DISTRIBUTION_CERTIFICATE }}" | base64 --decode > dist.p12
      #     security create-keychain -p keychainPassword build.keychain
      #     security import dist.p12 -P "${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}" -A -t cert -f pkcs12 -k ~/Library/Keychains/build.keychain
      #     security set-key-partition-list -S apple-tool:,apple: -s -k keychainPassword ~/Library/Keychains/build.keychain

      # - name: Sign IPA
      #   run: |
      #     codesign --force --sign "iPhone Distribution" --entitlements entitlements.plist --timestamp=none extApp.ipa
      #   working-directory: ./SafariExtApp

#      - name: Upload to TestFlight
#        run: |
#          transporter upload -f extApp.ipa -u ${{ secrets.APPLE_ID }} -p ${{ secrets.APP_SPECIFIC_PASSWORD }} -T "TestFlight"
#        env:
#          DELIVER_ITMSTRANSPORTER_ADDITIONAL_UPLOAD_PARAMETERS: "-t DAV"
